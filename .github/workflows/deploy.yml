name: Deploy to Self-Hosted Server

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— pushí•  ë•Œ ì‹¤í–‰
      - master  # ë˜ëŠ” master ë¸Œëœì¹˜
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: self-hosted  # self-hosted runner ì‚¬ìš©
    
    steps:
      - name: ğŸ“¦ ì²´í¬ì•„ì›ƒ ì½”ë“œ
        uses: actions/checkout@v3
        with:
          clean: false  # ê¸°ì¡´ íŒŒì¼ ìœ ì§€
      
      - name: ğŸ“ í˜„ì¬ ë””ë ‰í† ë¦¬ í™•ì¸
        run: |
          echo "í˜„ì¬ ë””ë ‰í† ë¦¬: $(pwd)"
          echo "íŒŒì¼ ëª©ë¡:"
          ls -la
      
      - name: ğŸ”§ Node.js ë²„ì „ í™•ì¸
        run: |
          echo "Node.js ë²„ì „: $(node -v)"
          echo "npm ë²„ì „: $(npm -v)"
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          echo "ğŸ“¦ npm íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
          npm install
          echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"
      
      - name: ğŸ” í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ í™•ì¸
        run: |
          if [ -f .env ]; then
            echo "âœ… .env íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤."
          else
            echo "âš ï¸  .env íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë°°í¬ ì „ì— ìƒì„±í•´ì£¼ì„¸ìš”."
            exit 1
          fi
      
      - name: ğŸ”„ PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
        run: |
          # PM2ê°€ ì„¤ì¹˜ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
          if ! command -v pm2 &> /dev/null; then
            echo "âš ï¸  PM2ê°€ ì„¤ì¹˜ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ì„¤ì¹˜ ì¤‘..."
            npm install -g pm2
          fi
          
          # PM2 í”„ë¡œì„¸ìŠ¤ í™•ì¸
          if pm2 list | grep -q "bloomdent-api"; then
            echo "ğŸ”„ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì¬ì‹œì‘ ì¤‘..."
            pm2 restart bloomdent-api
          else
            echo "ğŸš€ ìƒˆë¡œìš´ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì¤‘..."
            pm2 start server.js --name bloomdent-api
          fi
          
          # PM2 ìƒíƒœ í™•ì¸
          pm2 list
          echo "âœ… ë°°í¬ ì™„ë£Œ!"
      
      - name: ğŸ’¾ PM2 ì„¤ì • ì €ì¥
        run: |
          pm2 save
          echo "âœ… PM2 ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤."
      
      - name: ğŸ“Š ë°°í¬ ì •ë³´ ì¶œë ¥
        run: |
          echo "======================================"
          echo "ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "======================================"
          echo "ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ì»¤ë°‹: ${{ github.sha }}"
          echo "ì‘ì„±ì: ${{ github.actor }}"
          echo "ì‹œê°„: $(date)"
          echo "======================================"

